<!doctype html>

<html>

<head>

  <meta charset="utf-8">

  <title>WebView Bridge Probe</title>

  <meta name="viewport" content="width=device-width,initial-scale=1">

  <style>

    body { font-family: Arial, sans-serif; padding: 16px; max-width:900px; margin:auto; }

    pre { background:#f4f4f4; padding:10px; border-radius:6px; max-height:340px; overflow:auto; white-space:pre-wrap;}

    .ok { color: green; } .bad { color: darkred; }

    input, button { font-size:14px; padding:8px; margin-top:8px; width:100%; box-sizing:border-box; }

    label { font-weight:600; display:block; margin-top:10px; }

    footer { margin-top:18px; font-size:13px; color:#666; }

  </style>

</head>

<body>

  <h1>WebView Bridge Probe</h1>

  <p>صفحة اختبار تبحث عن واجهات Java⇄JS في WebView. ستعرض النتائج محليًا وترسلها للسيرفر (POST).</p>

  <label>عنوان إرسـال التقرير (مثال):</label>

  <input id="logUrl" value="/probe-log">

  <button id="runBtn">تشغيل الفحص</button>

  <h3>نتائج محلية</h3>

  <pre id="out">لم يُشغّل الفحص بعد.</pre>

<script>

async function sendLog(url, payload) {

  try {

    // إذا كان url نسبيّاً، نستخدم نفس الدومين

    await fetch(url, {

      method: 'POST',

      headers: {'Content-Type':'application/json'},

      body: JSON.stringify(payload),

      credentials: 'omit'

    });

  } catch (e) {

    console.warn("sendLog failed", e);

  }

}

function safeCall(obj, name, args) {

  try {

    const v = obj[name];

    if (typeof v === 'function') {

      if (['ping','echo','version','getInfo'].includes(name)) {

        try {

          const res = obj[name].apply(obj, args || []);

          return {called:true, result: res};

        } catch (e) {

          return {called:true, error: ''+e};

        }

      } else {

        return {called:false, reason:"not in safe-call whitelist"};

      }

    } else {

      return {called:false, reason:"not a function"};

    }

  } catch(e) {

    return {called:false, error:''+e};

  }

}

document.getElementById('runBtn').addEventListener('click', async ()=>{

  const logUrl = document.getElementById('logUrl').value.trim();

  const out = document.getElementById('out');

  out.textContent = "جارٍ الفحص...\n";

  const candidateNames = ['Android','gameBridge','JSBridge','nativeBridge','bridge','windowBridge','AndroidBridge','app','AndroidInterface','AppInterface'];

  const found = [];

  for (const name of candidateNames) {

    try {

      const obj = window[name];

      if (obj !== undefined && obj !== null) {

        let keys = [];

        try {

          keys = Object.keys(obj);

        } catch(e) {

          try {

            for (const k in obj) keys.push(k);

          } catch(e2) {

            keys = ['<non-enumerable or blocked>'];

          }

        }

        const safeResults = {};

        for (const testName of ['ping','echo','version','getInfo']) {

          safeResults[testName] = safeCall(obj, testName, ['probe']);

        }

        found.push({name, keys, safeResults});

        out.textContent += `FOUND bridge: ${name}\n keys: ${JSON.stringify(keys)}\n safeCalls: ${JSON.stringify(safeResults)}\n\n`;

      } else {

        out.textContent += `no bridge: ${name}\n`;

      }

    } catch (e) {

      out.textContent += `error checking ${name}: ${e}\n`;

    }

  }

  // تفحص خصائص النافذة بحثا عن كلمات مشبوهة

  try {

    const extras = [];

    const winKeys = Object.getOwnPropertyNames(window);

    for (const k of winKeys) {

      const kl = k.toLowerCase();

      if ((kl.includes('bridge') || kl.includes('android') || kl.includes('native')) && candidateNames.indexOf(k) === -1) {

        extras.push(k);

      }

    }

    if (extras.length) {

      out.textContent += `\nOther suspicious window keys: ${JSON.stringify(extras)}\n`;

      found.push({name:'suspects', keys: extras});

    }

  } catch(e){ /* ignore */ }

  const payload = {

    ts: new Date().toISOString(),

    url: location.href,

    report: found,

    ua: navigator.userAgent || null

  };

  out.textContent += "\nإرسال التقرير إلى السيرفر...\n";

  await sendLog(logUrl, payload);

  out.textContent += "انتهى الفحص. تحقق من سجل الخادم.\n";

});

</script>

<footer>

  ملاحظة: السكربت يتجنّب استدعاء دوال خطرة افتراضياً. إن أردت محاولة استدعاءات أعمق سأزوّدك بتعديلات.

</footer>

</body>

</html>
